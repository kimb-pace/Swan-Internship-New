---
title: "NMDS"
output: html_document
date: "2025-02-13"
---


# Setup
```{r}
library(vegan)
library(permute)
library(lattice)
library(dplyr)
library(tidyr)
library(ggplot2)
library(tidyverse)
library(readxl)
library(here)
```

# Load Dataframes 
```{r}
#General 
canopy_cover <- read_xlsx(here("Data/Modified/canopy_cover.xlsx"))
plot_elevation_data <- read_xlsx(here("Data/Modified/plot_elevation_data.xlsx"))
taxa_filtered <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/taxa_filtered.xlsx"))
```

# Alpine NMDS Analysis 

## Manage Dataframes 
```{r}
#Load
alpine_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/alpine_df_vasc_filtered.xlsx"))
alpine_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/alpine_df_lichen_filtered.xlsx"))
alpine_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/alpine_df_nonvasc_filtered.xlsx"))

#Create species matrices 
alpine_composition <- alpine_df[,c(8:261)]
alpine_composition <- as.matrix(alpine_composition) 
    
alpine_lichen_composition <- alpine_df_lichen[,c(10:167)]
alpine_lichen_composition <- as.matrix(alpine_lichen_composition) 
    
alpine_nonvasc_composition <- alpine_df_nonvasc[,c(10:210)]
alpine_nonvasc_composition <- as.matrix(alpine_nonvasc_composition) 
```


## Vascular 
```{r}
#Run NMDS 
      mds_alpine <- metaMDS(alpine_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Desriptive info for caption 
      length(unique(alpine_df[["Plot"]])) #number of plots 
      length(unique(alpine_df_lichen[["Viereck.3"]]))
      mds_alpine$stress #stress value
      mds_alpine$iters #number of iterations 
      
#define colors 
veg_colors <- c("orange", "blue3", "cyan", "orchid3")
      names(veg_colors) <- unique(alpine_df$Viereck.3)

#define axis so they match
    xlim <- c(-1.5, 1.5)
    ylim <- c(-1.5, 1.5)

#Plot with base overlay options 
    dev.off()
      ordiplot(mds_alpine, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.07",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_alpine, display = "sites"),
             col = veg_colors[alpine_df$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19,
             cex = 1.4)
      ordiarrows(mds_alpine, 
                 groups = alpine_df$Plot, 
                 levels = alpine_df$Sample_Year, col = 'blue')
      ordihull(mds_alpine, groups = alpine_df$Park, draw ="polygon", label = TRUE, cex = 1.8)

#plot labels
    text(mds_alpine, display = "sites", labels = alpine_df$Plot, col = "black", cex = 0.7, pos = 4)
    #adding only select labels 
    selected_plots <- c("116", "S980")
    nmds_scores <- as.data.frame(scores(mds_alpine, display = "sites"))
    nmds_scores$Plot <- alpine_df$Plot
    selected_scores <- nmds_scores[nmds_scores$Plot %in% selected_plots, ]
    text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$Plot,
         col = "black", cex = 0.7, pos = 4)

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_alpine, display = "sites")[, 1]
      species_cor <- apply(alpine_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_alpine, display = "sites")[, 2]
      species_cor <- apply(alpine_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Lichen 
```{r}
#Run NMDS 
      mds_alpine_lichen <- metaMDS(alpine_lichen_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption 
      length(unique(alpine_df_lichen[["Plot"]])) #number of plots 
      mds_alpine_lichen$stress #stress value 
      mds_alpine_lichen$iters #number of iterations 

#Define colors 
veg_colors <- c("cyan", "orchid3", "orange", "blue3", "gray")
      names(veg_colors) <- unique(alpine_df_lichen$Viereck.3)

#define axis 
      xlim <- c(-1.5, 1.5)
      ylim <- c(-1.5, 1.5)

#plot with base overlays 
      dev.off()
      ordiplot(mds_alpine_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "2",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_alpine_lichen, display = "sites"),
             col = veg_colors[alpine_df_lichen$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, 
             cex = 1.4)
      ordiarrows(mds_alpine_lichen, 
                 groups = alpine_df_lichen$Plot, 
                 levels = alpine_df_lichen$Sample_Year, col = 'blue')
      ordihull(mds_alpine_lichen, groups = alpine_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)

#Plot labels if desired 
      text(mds_alpine_lichen, display = "sites", labels = alpine_df_lichen$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_alpine_lichen, display = "sites"))
      nmds_scores$PlotID <- alpine_df_lichen$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_alpine_lichen, display = "sites")[, 1]
      species_cor <- apply(alpine_lichen_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_alpine_lichen, display = "sites")[, 2]
      species_cor <- apply(alpine_lichen_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))


```


## Nonvascular 
```{r}
#Run NMDS
    mds_alpine_nonvasc <- metaMDS(alpine_nonvasc_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#descriptive info for caption
      length(unique(alpine_df_nonvasc[["Plot"]])) #number of plots 
      mds_alpine_nonvasc$stress #stress value 
      mds_alpine_nonvasc$iters #number of iterations 

#define colors 
veg_colors <- c("orange", "blue3", "cyan", "orchid3", "gray")
      names(veg_colors) <- unique(alpine_df_nonvasc$Viereck.3)
      dev.off()
#define axis 
      xlim <- c(-1, 1.5)
      ylim <- c(-1, 1)

#plot with base overlay options 
      ordiplot(mds_alpine_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.11",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "3",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_alpine_nonvasc, display = "sites"),
             col = veg_colors[alpine_df_nonvasc$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19,
             cex = 1.4)
      ordiarrows(mds_alpine_nonvasc, 
                 groups = alpine_df_nonvasc$Plot, 
                 levels = alpine_df_nonvasc$Sample_Year, col = 'blue')
      ordihull(mds_alpine_nonvasc, groups = alpine_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)

#plotID labels
      text(mds_alpine_nonvasc, display = "sites", labels = alpine_df_nonvasc$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_alpine_nonvasc, display = "sites"))
      nmds_scores$PlotID <- alpine_df_nonvasc$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

beetle_nonvasc_plot_viereck <- recordPlot()

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_alpine_nonvasc, display = "sites")[, 1]
      species_cor <- apply(alpine_nonvasc_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_alpine_nonvasc, display = "sites")[, 2]
      species_cor <- apply(alpine_nonvasc_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

```




# Spruce Beetle NMDS Analysis 

## Manage Dataframes 
```{r}
#Load
    beetle_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/beetle_df_vasc_filtered.xlsx"))
    beetle_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/beetle_df_lichen_filtered.xlsx"))
    beetle_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/beetle_df_nonvasc_filtered.xlsx"))

#Create species matrices 
beetle_composition <- beetle_df[,c(8:261)]
beetle_composition <- as.matrix(beetle_composition) 
    
beetle_lichen_composition <- beetle_df_lichen[,c(10:167)]
beetle_lichen_composition <- as.matrix(beetle_lichen_composition) 
    
beetle_nonvasc_composition <- beetle_df_nonvasc[,c(10:210)]
beetle_nonvasc_composition <- as.matrix(beetle_nonvasc_composition) 

#add canopy cover info to dataframes 
    beetle_df <- beetle_df %>%
      left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
    beetle_df <- beetle_df %>% distinct()
    beetle_df_lichen <- beetle_df_lichen %>%
      left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
    beetle_df_lichen <- beetle_df_lichen %>% distinct()
    beetle_df_nonvasc <- beetle_df_nonvasc %>%
      left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
    beetle_df_nonvasc <- beetle_df_nonvasc %>% distinct()
```

## Vascular 
```{r}
#Run NMDS 
      mds_beetle <- metaMDS(beetle_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Desriptive info for caption 
      length(unique(beetle_df[["Plot"]])) #number of plots 
      mds_beetle$stress #stress value
      mds_beetle$iters #number of iterations 

#define colors 
      veg_colors <- c("orange", "blue3")
      names(veg_colors) <- unique(beetle_df$Viereck.3)

#define axis 
    xlim <- c(-1.5, 1.5)
    ylim <- c(-1.5, 1.5)

#Plot with base overlay options 
    dev.off()
      ordiplot(mds_beetle, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.07",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_beetle, display = "sites"),
             col = veg_colors[beetle_df$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19,
             cex = 1.4)
      ordiarrows(mds_beetle, 
                 groups = beetle_df$Plot, 
                 levels = beetle_df$Sample_Year, col = 'blue')
      ordihull(mds_beetle, groups = beetle_df$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by canopy cover gradient 
      nmds_scores <- scores(scores(mds_beetle, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- beetle_df$Plot_Year
      nmds_scores$Percent_Cover <- beetle_df$Percent_Cover
      color_gradient <- colorRampPalette(c("red", "blue"))(100)
      ordiplot(mds_beetle, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.07",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#plot labels
    text(mds_beetle, display = "sites", labels = beetle_df$Plot, col = "black", cex = 0.7, pos = 4)
    #adding only select labels 
    selected_plots <- c("116", "S980")
    nmds_scores <- as.data.frame(scores(mds_beetle, display = "sites"))
    nmds_scores$Plot <- beetle_df$Plot
    selected_scores <- nmds_scores[nmds_scores$Plot %in% selected_plots, ]
    text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$Plot,
         col = "black", cex = 0.7, pos = 4)

beetlevasc_plot_viereck <- recordPlot()

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_beetle, display = "sites")[, 1]
      species_cor <- apply(beetle_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_beetle, display = "sites")[, 2]
      species_cor <- apply(beetle_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Lichen 
```{r}
#Run NMDS 
      mds_beetle_lichen <- metaMDS(beetle_lichen_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption 
      length(unique(beetle_df_lichen[["Plot"]])) #number of plots 
      mds_beetle_lichen$stress #stress value 
      mds_beetle_lichen$iters #number of iterations 

#Define colors 
      veg_colors <- c("orange", "blue3")
      names(veg_colors) <- unique(beetle_df_lichen$Viereck.3)

#define axis 
      xlim <- c(-1.5, 1.5)
      ylim <- c(-1.5, 1.5)

#plot with base overlays 
      dev.off()
      ordiplot(mds_beetle_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "2",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_beetle_lichen, display = "sites"),
             col = veg_colors[beetle_df_lichen$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, 
             cex = 1.4)
      ordiarrows(mds_beetle_lichen, 
                 groups = beetle_df_lichen$Plot, 
                 levels = beetle_df_lichen$Sample_Year, col = 'blue')
      ordihull(mds_beetle_lichen, groups = beetle_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)


#coloring by canopy cover gradient 
      nmds_scores <- scores(scores(mds_beetle_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- beetle_df_lichen$Plot_Year
      nmds_scores$Percent_Cover <- beetle_df_lichen$Percent_Cover
      color_gradient <- colorRampPalette(c("red", "blue"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_beetle_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "2",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Plot labels if desired 
      text(mds_beetle_lichen, display = "sites", labels = beetle_df_lichen$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_beetle_lichen, display = "sites"))
      nmds_scores$PlotID <- beetle_df_lichen$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

beetle_lichen_plot_viereck <- recordPlot()

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_beetle_lichen, display = "sites")[, 1]
      species_cor <- apply(beetle_lichen_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_beetle_lichen, display = "sites")[, 2]
      species_cor <- apply(beetle_lichen_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Nonvascular 
```{r}
#Run NMDS
    mds_beetle_nonvasc <- metaMDS(beetle_nonvasc_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#descriptive info for caption
      length(unique(beetle_df_nonvasc[["Plot"]])) #number of plots 
      mds_beetle_nonvasc$stress #stress value 
      mds_beetle_nonvasc$iters #number of iterations 

#define colors 
      veg_colors <- c("orange", "blue3")
      names(veg_colors) <- unique(beetle_df_nonvasc$Viereck.3)
      dev.off()
#define axis 
      xlim <- c(-1, 1.5)
      ylim <- c(-1, 1)

#plot with base overlay options 
      ordiplot(mds_beetle_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.11",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "3",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_beetle_nonvasc, display = "sites"),
             col = veg_colors[beetle_df_nonvasc$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19,
             cex = 1.4)
      ordiarrows(mds_beetle_nonvasc, 
                 groups = beetle_df_nonvasc$Plot, 
                 levels = beetle_df_nonvasc$Sample_Year, col = 'blue')
      ordihull(mds_beetle_nonvasc, groups = beetle_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by canopy cover gradient 
      nmds_scores <- scores(scores(mds_beetle_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- beetle_df_nonvasc$Plot_Year
      nmds_scores$Percent_Cover <- beetle_df_nonvasc$Percent_Cover
      color_gradient <- colorRampPalette(c("red", "blue"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_beetle_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.11",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "3",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#plotID labels
      text(mds_beetle_nonvasc, display = "sites", labels = beetle_df_nonvasc$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_beetle_nonvasc, display = "sites"))
      nmds_scores$PlotID <- beetle_df_nonvasc$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

beetle_nonvasc_plot_viereck <- recordPlot()

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_beetle_nonvasc, display = "sites")[, 1]
      species_cor <- apply(beetle_nonvasc_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_beetle_nonvasc, display = "sites")[, 2]
      species_cor <- apply(beetle_nonvasc_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


# Spruce Forest NMDS Analysis 

## Manage Dataframes 
```{r}
#Load 
forest_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/forest_df_vasc_filtered.xlsx"))
forest_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/forest_df_lichen_filtered.xlsx"))
forest_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/forest_df_nonvasc_filtered.xlsx")) 

#create species matrix for NMDS 
          forest_composition <- forest_df[,c(8:261)]
          forest_composition <- as.matrix(forest_composition) 

          forest_composition_lichen <- forest_df_lichen[,c(10:167)]
          forest_composition_lichen <- as.matrix(forest_composition_lichen) 

          forest_composition_nonvasc <- forest_df_nonvasc[,c(10:210)]
          forest_composition_nonvasc <- as.matrix(forest_composition_nonvasc)

#add canopy cover info to dataframes 
forest_df <- forest_df %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
forest_df <- forest_df %>% distinct()
forest_df_lichen <- forest_df_lichen %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
forest_df_lichen <- forest_df_lichen %>% distinct()
forest_df_nonvasc <- forest_df_nonvasc %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
forest_df_nonvasc <- forest_df_nonvasc %>% distinct()

#add elevation info to dataframes 
forest_df <- forest_df %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
forest_df_lichen <- forest_df_lichen %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
forest_df_nonvasc <- forest_df_nonvasc %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
```

## Vascular 
```{r}
#Run NMDS 
    mds_forest <- metaMDS(forest_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Get descriptive info for caption 
    length(unique(forest_df[["Plot"]])) #number of plots 
    mds_forest$stress #stress value 
    mds_forest$iters #number of iterations 

#define colors 
    veg_colors <- c("orange", "blue3")
    names(veg_colors) <- unique(forest_df$Viereck.3)
    dev.off()
#define axis 
    xlim <- c(-1.5, 1.5)
    ylim <- c(-1.5, 1.5)

#plot with base overlay options 
      ordiplot(mds_forest, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.08",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "4",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_forest, display = "sites"),
             col = veg_colors[forest_df$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomleft", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_forest, 
                 groups = forest_df$Plot, 
                 levels = forest_df$Sample_Year, col = 'blue')
      ordihull(mds_forest, groups = forest_df$Park, draw ="polygon", label = TRUE, cex = 1.8)

forestvasc_plot_viereck <- recordPlot()

#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_forest, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df$Plot_Year
      nmds_scores$Elevation <- forest_df$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_forest, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.08",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "4",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_forest, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df$Plot_Year
      nmds_scores$Percent_Cover <- forest_df$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_forest, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.08",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "4",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Species Loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_forest, display = "sites")[, 1]
      species_cor <- apply(forest_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_forest, display = "sites")[, 2]
      species_cor <- apply(forest_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Lichen 
```{r}
#Run NMDS 
      mds_forest_lichen <- metaMDS(forest_composition_lichen, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption
      length(unique(forest_df_lichen[["Plot"]])) #number of plots 
      mds_forest_lichen$stress #stress value
      mds_forest_lichen$iters #number of iterations 

#define colors
      veg_colors <- c("orange", "blue3")
      names(veg_colors) <- unique(forest_df_lichen$Viereck.3)
      dev.off()

#define axis 
      xlim <- c(-1.5, 1.5)
      ylim <- c(-1.5, 1.5)

#plot with base overlay options 
      ordiplot(mds_forest_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.16",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "5",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_forest_lichen, display = "sites"),
             col = veg_colors[forest_df_lichen$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_forest_lichen, 
                 groups = forest_df_lichen$Plot, 
                 levels = forest_df_lichen$Sample_Year, col = 'blue')
      ordihull(mds_forest_lichen, groups = forest_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_forest_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df_lichen$Plot_Year
      nmds_scores$Elevation <- forest_df_lichen$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_forest_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.16",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "5",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_forest_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df_lichen$Plot_Year
      nmds_scores$Percent_Cover <- forest_df_lichen$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_forest_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.16",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "5",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Plot labels if desired 
      text(mds_forest_lichen, display = "sites", labels = forest_df_lichen$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_forest_lichen, display = "sites"))
      nmds_scores$PlotID <- forest_df_lichen$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

forestlichen_plot_viereck <- recordPlot()

#Species Loading Values 
  #axis1 scores 
      axis1_scores <- scores(mds_forest_lichen, display = "sites")[, 1]
      species_cor <- apply(forest_composition_lichen, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_forest_lichen, display = "sites")[, 2]
      species_cor <- apply(forest_composition_lichen, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Nonvascular 
```{r}
#Run NMDS 
      mds_forest_nonvasc <- metaMDS(forest_composition_nonvasc, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption 
      length(unique(forest_df_nonvasc[["Plot"]])) #number of plots 
      mds_forest_nonvasc$stress #stress value 
      mds_forest_nonvasc$iters #number of iterations 

#define colors 
      veg_colors <- c("orange", "blue3")
      names(veg_colors) <- unique(forest_df_nonvasc$Viereck.3)
      dev.off()

#define axis 
      xlim <- c(-1.5, 1.5)
      ylim <- c(-1.5, 1.5)

#Plot with base overlay options 
      ordiplot(mds_forest_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.14",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "6",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_forest_nonvasc, display = "sites"),
             col = veg_colors[forest_df_nonvasc$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomleft", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_forest_nonvasc, 
                 groups = forest_df_nonvasc$Plot, 
                 levels = forest_df_nonvasc$Sample_Year, col = 'blue')
      ordihull(mds_forest_nonvasc, groups = forest_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_forest_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df_nonvasc$Plot_Year
      nmds_scores$Elevation <- forest_df_nonvasc$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_forest_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.14",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "6",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_forest_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- forest_df_nonvasc$Plot_Year
      nmds_scores$Percent_Cover <- forest_df_nonvasc$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_forest_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.14",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "6",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Plot labels if desired 
      text(mds_forest_nonvasc, display = "sites", labels = forest_df_nonvasc$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_forest_nonvasc, display = "sites"))
      nmds_scores$PlotID <- forest_df_nonvasc$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

forestnonvasc_plot_viereck <- recordPlot()

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_forest_nonvasc, display = "sites")[, 1]
      species_cor <- apply(forest_composition_nonvasc, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_forest_nonvasc, display = "sites")[, 2]
      species_cor <- apply(forest_composition_nonvasc, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```



# Spruce Woodland NMDS Analysis 

## Manage Dataframes 
```{r}
#Load 
needle_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/needle_df_vasc_filtered.xlsx"))
needle_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/needle_df_lichen_filtered.xlsx"))
needle_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/needle_df_nonvasc_filtered.xlsx"))

#create NMDS species matrix 
          needle_composition <- needle_df[,c(8:261)]
          needle_composition <- as.matrix(needle_composition) 

          needle_composition_lichen <- needle_df_lichen[,c(10:167)]
          needle_composition_lichen <- as.matrix(needle_composition_lichen)

          needle_composition_nonvasc <- needle_df_nonvasc[,c(10:210)]
          needle_composition_nonvasc <- as.matrix(needle_composition_nonvasc) 

#Add canopy cover info for overlay 
needle_df <- needle_df %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
needle_df <- needle_df %>% distinct()
needle_df_lichen <- needle_df_lichen %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
needle_df_lichen <- needle_df_lichen %>% distinct()
needle_df_nonvasc <- needle_df_nonvasc %>%
  left_join(canopy_cover %>% select(Plot_Year, Percent_Cover), by = c("Plot_Year"))
needle_df_nonvasc <- needle_df_nonvasc %>% distinct()

needle_df <- needle_df %>%
  mutate(Percent_Cover = ifelse(is.na(Percent_Cover), 0, Percent_Cover))
needle_df_lichen <- needle_df_lichen %>%
  mutate(Percent_Cover = ifelse(is.na(Percent_Cover), 0, Percent_Cover))
needle_df_nonvasc <- needle_df_nonvasc %>%
  mutate(Percent_Cover = ifelse(is.na(Percent_Cover), 0, Percent_Cover))

#add elevation info for overlay 
needle_df <- needle_df %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
needle_df_lichen <- needle_df_lichen %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
needle_df_nonvasc <- needle_df_nonvasc %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
```

## Vascular 
```{r}
#Run NMDS 
      mds_needle <- metaMDS(needle_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption 
      length(unique(needle_df[["Plot"]])) #number of plots  
      mds_needle$stress #stress
      mds_needle$iters #number of iterations 

#define colors 
      veg_colors <- c("seagreen3")
      names(veg_colors) <- unique(needle_df$Viereck.3)
      dev.off()
#define axis 
      xlim <- c(0, 2)
      ylim <- c(-1, 1.5)

#Plot with base overlay 
      ordiplot(mds_needle, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.12",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_needle, display = "sites"),
             col = veg_colors[needle_df$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomleft", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_needle, 
                 groups = needle_df$Plot, 
                 levels = needle_df$Sample_Year, col = 'blue')
      ordihull(mds_needle, groups = needle_df$Park, draw ="polygon", label = TRUE, cex = 1.8)


#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_needle, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df$Plot_Year
      nmds_scores$Elevation <- needle_df$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_needle, type = "n", xlim = xlim, ylim = ylim, 
                     cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
                     xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
                 y = par("usr")[4] - 0.1,
                 labels = "Stress = 0.12",
                 pos = 4.1, #1: below, 2 left, 3 above, 4 right 
                 cex = 2, #size 
                 col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_needle, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df$Plot_Year
      nmds_scores$Percent_Cover <- needle_df$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_needle, type = "n", xlim = xlim, ylim = ylim, 
                     cex.axis = 1.5, cex.lab = 1.4, main = "Vascular Species", cex.main = 2,
                     xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
                 y = par("usr")[4] - 0.1,
                 labels = "Stress = 0.12",
                 pos = 4.1, #1: below, 2 left, 3 above, 4 right 
                 cex = 2, #size 
                 col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Plot labels if desired 
      text(mds_needle, display = "sites", labels = needle_df$Plot, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_needle, display = "sites"))
      nmds_scores$PlotID <- needle_df$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species loading values 
      
  #axis1 scores 
      axis1_scores <- scores(mds_needle, display = "sites")[, 1]
      species_cor <- apply(needle_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_needle, display = "sites")[, 2]
      species_cor <- apply(needle_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Lichen 
```{r}
#Run NMDS 
    mds_needle_lichen <- metaMDS(needle_composition_lichen, distance = "bray", k = 3, autotransform = TRUE, trymax = 200) 

#Descriptive info for caption 
    length(unique(needle_df_lichen[["Plot"]])) #number of plots 
    mds_needle_lichen$stress #stress value 
    mds_needle_lichen$iters #number of iterations 

#Define colors 
    veg_colors <- c("seagreen3")
    names(veg_colors) <- unique(needle_df_lichen$Viereck.3)
    dev.off()
#define axis 
    xlim <- c(-1.5, 1.5)
    ylim <- c(-1.5, 1.5)

#plot with base overlay options
      ordiplot(mds_needle_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_needle_lichen, display = "sites"),
             col = veg_colors[needle_df_lichen$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomleft", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_needle_lichen, 
                 groups = needle_df_lichen$Plot, 
                 levels = needle_df_lichen$Sample_Year, col = 'blue')
      ordihull(mds_needle_lichen, groups = needle_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)
      ordihull(mds_needle_lichen, groups = needle_df_lichen$Elevation_Band, draw ="polygon", label = TRUE)
      legend("bottomright", title = "Elevation Band",
             legend=c("01 (<450 m)", "02 (450-900 m)"),
             ncol=1)

#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_needle_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df_lichen$Plot_Year
      nmds_scores$Elevation <- needle_df_lichen$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_needle_lichen, type = "n", xlim = xlim, ylim = ylim, 
                     cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
                     xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
                 y = par("usr")[4] - 0.1,
                 labels = "Stress = 0.13",
                 pos = 4.1, #1: below, 2 left, 3 above, 4 right 
                 cex = 2, #size 
                 col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_needle_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df_lichen$Plot_Year
      nmds_scores$Percent_Cover <- needle_df_lichen$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_needle_lichen, type = "n", xlim = xlim, ylim = ylim, 
                     cex.axis = 1.5, cex.lab = 1.4, main = "Lichen Species", cex.main = 2,
                     xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
                 y = par("usr")[4] - 0.1,
                 labels = "Stress = 0.13",
                 pos = 4.1, #1: below, 2 left, 3 above, 4 right 
                 cex = 2, #size 
                 col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)


#plot labels if desired 
      text(mds_needle_lichen, display = "sites", labels = needle_df_lichen$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_needle_lichen, display = "sites"))
      nmds_scores$PlotID <- needle_df_lichen$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_needle_lichen, display = "sites")[, 1]
      species_cor <- apply(needle_composition_lichen, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_needle_lichen, display = "sites")[, 2]
      species_cor <- apply(needle_composition_lichen, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```

## Nonvascular 
```{r}
#Run NMDS 
      mds_needle_nonvasc <- metaMDS(needle_composition_nonvasc, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Descriptive info for caption 
      length(unique(needle_df_nonvasc[["Plot"]])) #number of plots 
      mds_needle_nonvasc$stress #stress value 
      mds_needle_nonvasc$iters #number of iterations 

#define colors 
      veg_colors <- c("seagreen3")
      names(veg_colors) <- unique(needle_df_nonvasc$Viereck.3)
      dev.off()
#define axis 
      xlim <- c(-0.5, 0.75)
      ylim <- c(-0.5, 1)

#plot with base overlay options 
      ordiplot(mds_needle_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.12",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "2",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_needle_nonvasc, display = "sites"),
             col = veg_colors[needle_df_nonvasc$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomleft", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_needle_nonvasc, 
                 groups = needle_df_nonvasc$Plot, 
                 levels = needle_df_nonvasc$Sample_Year, col = 'blue')
      ordihull(mds_needle_nonvasc, groups = needle_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)

plot <- recordPlot()

#plotID labels
      text(mds_needle_nonvasc, display = "sites", labels = needle_df_nonvasc$PlotID, col = "black", cex = 0.7, pos = 4)

#coloring by gradient - elevation 
      nmds_scores <- scores(scores(mds_needle_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df_nonvasc$Plot_Year
      nmds_scores$Elevation <- needle_df_nonvasc$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_needle_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.12",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#coloring by gradient - Percent cover 
      nmds_scores <- scores(scores(mds_needle_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- needle_df_nonvasc$Plot_Year
      nmds_scores$Percent_Cover <- needle_df_nonvasc$Percent_Cover
      color_gradient <- colorRampPalette(c("orange", "blue3"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Percent_Cover, breaks = 100)]
      ordiplot(mds_needle_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Nonvascular Species", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.12",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Percent_Cover), 2),
             fill = color_gradient[c(1, 100)], title = "Percent Canopy Cover", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_needle_nonvasc, display = "sites")[, 1]
      species_cor <- apply(needle_composition_nonvasc, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_needle_nonvasc, display = "sites")[, 2]
      species_cor <- apply(needle_composition_nonvasc, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```



# Low Shrub NMDS Analysis 

## Manage Dataframes 
```{r}
#Load 
openlow_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/openlow_df_vasc_filtered.xlsx"))
openlow_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/openlow_df_lichen_filtered.xlsx"))
openlow_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/openlow_df_nonvasc_filtered.xlsx"))

#turn species data into matrix 
      openlow_composition <- openlow_df[,c(8:261)]
      openlow_composition <- as.matrix(openlow_composition) 

      openlow_composition_lichen <- openlow_df_lichen[,c(10:167)]
      openlow_composition_lichen <- as.matrix(openlow_composition_lichen)

      openlow_composition_nonvasc <- openlow_df_nonvasc[,c(10:210)]
      openlow_composition_nonvasc <- as.matrix(openlow_composition_nonvasc)

#add elevation data to dataframes for overlay 
openlow_df <- openlow_df %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
openlow_df_lichen <- openlow_df_lichen %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
openlow_df_nonvasc <- openlow_df_nonvasc %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")

```

## Vascular 
```{r}
#Run NMDS
    mds_openlow <- metaMDS(openlow_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Get Descriptive Info for caption 
    length(unique(openlow_df[["Plot"]])) #number of plots
    mds_openlow$stress #stress value 
    mds_openlow$iters #iterations

#define colors 
    veg_colors <- c("orchid3")
    names(veg_colors) <- unique(openlow_df$Viereck.3)
    dev.off()
#define axis
    xlim <- c(-1, 1.5)
    ylim <- c(-1, 1.5)

#Plot with base overlay
    ordiplot(mds_openlow, type = "n", xlim = xlim, ylim = ylim, 
             cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Vascular Species)", cex.main = 2)
    text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.11",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "1",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    points(scores(mds_openlow, display = "sites"),
           col = veg_colors[openlow_df$Viereck.3],
           pch = 19, cex = 1.5)
    legend("bottomright", title = "Site Classification",
           legend=names(veg_colors),
           ncol=1,
           col = veg_colors, pch = 19, cex = 1.4)
    ordiarrows(mds_openlow, 
               groups = openlow_df$Plot, 
               levels = openlow_df$Sample_Year, col = 'blue')
    ordihull(mds_openlow, groups = openlow_df$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by elevation gradient overlay 
      nmds_scores <- scores(scores(mds_openlow, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- openlow_df$Plot_Year
      nmds_scores$Elevation <- openlow_df$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_openlow, type = "n", xlim = xlim, ylim = ylim, 
             cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Vascular Species)", cex.main = 2)
      text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.11",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomright", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#plotID labels if desired
      text(mds_openlow, display = "sites", labels = openlow_df$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_openlow, display = "sites"))
      nmds_scores$PlotID <- openlow_df$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species loading values 
    #axis1 scores 
        axis1_scores <- scores(mds_openlow, display = "sites")[, 1]
        species_cor <- apply(openlow_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
        species_cor_sorted <- sort(species_cor, decreasing = TRUE)
        head(species_cor_sorted, 10)
        tail(species_cor_sorted, 10)
        
        species_cor_sorted <- as.data.frame(species_cor_sorted)
        species_cor_sorted <- species_cor_sorted %>%
          rownames_to_column(var = "Code1")
        species_cor_sorted <- species_cor_sorted %>%
          rename(Loadings = species_cor_sorted)
        str(species_cor_sorted)
        species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
        taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
        species_cor_sorted <- species_cor_sorted %>%
          left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1") 
        species_cor_sorted <-species_cor_sorted %>% distinct()
        summary_df <- species_cor_sorted %>%
          arrange(Loadings) %>%
          slice(c(1:10, (n()-9):n()))

    #axis2 scores
        axis2_scores <- scores(mds_openlow, display = "sites")[, 2]
        species_cor <- apply(openlow_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
        species_cor_sorted <- sort(species_cor, decreasing = TRUE)
        head(species_cor_sorted, 10)
        tail(species_cor_sorted, 10)
        
        species_cor_sorted <- as.data.frame(species_cor_sorted)
        species_cor_sorted <- species_cor_sorted %>%
          rownames_to_column(var = "Code1")
        species_cor_sorted <- species_cor_sorted %>%
          rename(Loadings = species_cor_sorted)
        str(species_cor_sorted)
        species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
        taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
        species_cor_sorted <- species_cor_sorted %>%
          left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
        species_cor_sorted <-species_cor_sorted %>% distinct()
        
        summary_df <- species_cor_sorted %>%
          arrange(Loadings) %>%
          slice(c(1:10, (n()-9):n()))
```

## Lichen NMDS 
```{r}
#Run NMDS 
      mds_openlow_lichen <- metaMDS(openlow_composition_lichen, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Get descriptive info for caption 
      length(unique(openlow_df_lichen[["Plot"]])) #number of plots
      mds_openlow_lichen$stress #stress value
      mds_openlow_lichen$iters #number of iterations 

#Define colors 
      veg_colors <- c("orchid3")
      names(veg_colors) <- unique(openlow_df_lichen$Viereck.3)
      dev.off()
#define axis 
      xlim <- c(-1, 1.5)
      ylim <- c(-1, 1.5)

#plot with base overlay 
      ordiplot(mds_openlow_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Lichen Species)", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.15",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "2",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_openlow_lichen, display = "sites"),
             col = veg_colors[openlow_df_lichen$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_openlow_lichen, 
                 groups = openlow_df_lichen$Plot, 
                 levels = openlow_df_lichen$Sample_Year, col = 'blue')
      ordihull(mds_openlow_lichen, groups = openlow_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)

#coloring by elevation gradient 
      nmds_scores <- scores(scores(mds_openlow_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- openlow_df_lichen$Plot_Year
      nmds_scores$Elevation <- openlow_df_lichen$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_openlow_lichen, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Lichen Species)", cex.main = 2)
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.15",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "1",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      legend("bottomright", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Plot Labels if wanted 
      text(mds_openlow_lichen, display = "sites", labels = openlow_df_lichen$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_openlow_lichen, display = "sites"))
      nmds_scores$PlotID <- openlow_df_lichen$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species vector arrows if wanted 
      
      #all 
      species_fit <- envfit(mds_openlow_lichen, openlow_lichen_composition, perm = 999)
      species_scores <- as.data.frame(species_fit$vectors$arrows)
      species_scores$Species_Code <- rownames(species_scores)
      arrows(0,0,species_scores$NMDS1, species_scores$NMDS2, length = 0.1, col = "red")
      text(species_scores$NMDS1, species_scores$NMDS2, labels = species_scores$Species_Code, 
           col = "red", pos = c(3, 1, 4), offset = 0.5)
      
      #select species only 
      selected_species <- c("PEBR21", "NEBE60", "PEME60", "PENE12", "CLAR6", "MELO60", "LOHA60")
      filtered_scores <- species_scores %>% filter(Species_Code %in% selected_species)
      arrows(0, 0, filtered_scores$NMDS1, filtered_scores$NMDS2, length = 0.1, col = "red")
      text(filtered_scores$NMDS1, filtered_scores$NMDS2, labels = filtered_scores$Species_Code, 
           col = "red", pos = c(3), offset = 0.5)

#Species Loading Values 
    #axis1 scores 
      axis1_scores <- scores(mds_openlow_lichen, display = "sites")[, 1]
      species_cor <- apply(openlow_composition_lichen, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

    #axis2 scores
      axis2_scores <- scores(mds_openlow_lichen, display = "sites")[, 2]
      species_cor <- apply(openlow_composition_lichen, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```

## Nonvascular NMDS
```{r}
#Run NMDS
  mds_openlow_nonvasc <- metaMDS(openlow_composition_nonvasc, distance = "bray", k = 3, autotransform = TRUE, trymax = 200)

#Get descriptive info for caption 
  length(unique(openlow_df_nonvasc[["Plot"]])) #number of plots 
  mds_openlow_nonvasc$stress #stress
  mds_openlow_nonvasc$iters #iterations

#Define colors 
    veg_colors <- c("orchid3")
    names(veg_colors) <- unique(openlow_df_nonvasc$Viereck.3)
    dev.off()
#define axis 
    xlim <- c(-1, 1.5)
    ylim <- c(-1, 1.5)

#plot with base overlay 
      ordiplot(mds_openlow_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Nonvascular Species)", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "3",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      points(scores(mds_openlow_nonvasc, display = "sites"),
             col = veg_colors[openlow_df_nonvasc$Viereck.3],
             pch = 19, cex = 1.5)
      legend("bottomright", title = "Site Classification",
             legend=names(veg_colors),
             ncol=1,
             col = veg_colors, pch = 19, cex = 1.4)
      ordiarrows(mds_openlow_nonvasc, 
                 groups = openlow_df_nonvasc$Plot, 
                 levels = openlow_df_nonvasc$Sample_Year, col = 'blue')
      ordihull(mds_openlow_nonvasc, groups = openlow_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)


#coloring by elevation gradient 
      nmds_scores <- scores(scores(mds_openlow_nonvasc, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- openlow_df_nonvasc$Plot_Year
      nmds_scores$Elevation <- openlow_df_nonvasc$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      ordiplot(mds_openlow_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
               cex.axis = 1.5, cex.lab = 1.4, main = "Low Shrub (Nonvascular Species)", cex.main = 2,
               xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
           y = par("usr")[4] - 0.1,
           labels = "Stress = 0.13",
           pos = 4.1, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      text(x = par("usr")[2],
           y = par("usr")[4] - 0.1,
           labels = "3",
           pos = 2, #1: below, 2 left, 3 above, 4 right 
           cex = 2, #size 
           col = "black")
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      legend("bottomright", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.3)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#plot labels if desired 
      text(mds_openlow_nonvasc, display = "sites", labels = openlow_df_nonvasc$PlotID, col = "black", cex = 0.7, pos = 4)
      #adding only select labels 
      selected_plots <- c("116", "S980")
      nmds_scores <- as.data.frame(scores(mds_openlow_nonvasc, display = "sites"))
      nmds_scores$PlotID <- openlow_df_nonvasc$PlotID
      selected_scores <- nmds_scores[nmds_scores$PlotID %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
           col = "black", cex = 0.7, pos = 4)

#Species Loading values 

  #axis1 scores 
      axis1_scores <- scores(mds_openlow_nonvasc, display = "sites")[, 1]
      species_cor <- apply(openlow_composition_nonvasc, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_openlow_nonvasc, display = "sites")[, 2]
      species_cor <- apply(openlow_composition_nonvasc, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```



# Dwarf Shrub NMDS Analysis 
## Manage Dataframes 
```{r}
#Load 
dwarfscrub_df <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/dwarfscrub_df_vasc_filtered.xlsx"))
dwarfscrub_df_lichen <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/dwarfscrub_df_lichen_filtered.xlsx"))
dwarfscrub_df_nonvasc <- read_xlsx(here("Data/Modified/Collapsed_Species_Code_DFs/PERMANOVA_DF_QuickLoad/dwarfscrub_df_nonvasc_filtered.xlsx")) 

#Convert to species matrix
          dwarfscrub_composition <- dwarfscrub_df[,c(8:261)]
          dwarfscrub_composition <- as.matrix(dwarfscrub_composition) 

          dwarfscrub_composition_lichen <- dwarfscrub_df_lichen[,c(10:167)]
          dwarfscrub_composition_lichen <- as.matrix(dwarfscrub_composition_lichen) 

          dwarfscrub_composition_nonvasc <- dwarfscrub_df_nonvasc[,c(10:210)]
          dwarfscrub_composition_nonvasc <- as.matrix(dwarfscrub_composition_nonvasc)
 
#add elevation data for gradient overlay 
dwarfscrub_df <- dwarfscrub_df %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
dwarfscrub_df_lichen <- dwarfscrub_df_lichen %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
dwarfscrub_df_nonvasc <- dwarfscrub_df_nonvasc %>%
  left_join(plot_elevation_data %>% select(Plot, Elevation), by = "Plot")
```

## Vascular 
```{r}
#Run NMDS 
    mds_dwarfscrub <- metaMDS(dwarfscrub_composition, distance = "bray", k = 3, autotransform = TRUE, trymax = 200) #repeated 5 times 

#Descriptive info for caption 
    length(unique(dwarfscrub_df[["Plot"]])) #number of plots 
    mds_dwarfscrub$stress #stress value 
    mds_dwarfscrub$iters #number of iterations 

#define colors 
    veg_colors <- c("orange", "blue3")
    names(veg_colors) <- unique(dwarfscrub_df$Viereck.3)
    dev.off()
#define axis 
    xlim <- c(-1.5, 1)
    ylim <- c(-1.5, 1)

#Plot with base overlay 
    ordiplot(mds_dwarfscrub, type = "n", xlim = xlim, ylim = ylim, cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Vascular Species)", cex.main = 2,
             xlab = "NMDS1", ylab = "NMDS2")
    text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.08",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "2",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    points(scores(mds_dwarfscrub, display = "sites"),
           col = veg_colors[dwarfscrub_df$Viereck.3],
           pch = 19, cex = 1.5)
    legend("bottomleft", title = "Site Classification",
           legend=names(veg_colors),
           ncol=1,
           col = veg_colors, pch = 19, cex = 1.4)
    ordiarrows(mds_dwarfscrub, 
               groups = dwarfscrub_df$Plot, 
               levels = dwarfscrub_df$Sample_Year, col = 'blue')
    ordihull(mds_dwarfscrub, groups = dwarfscrub_df$Park, draw ="polygon", label = TRUE, cex = 1.8)

#elevation ordisurf overlay 
    ordisurf(mds_dwarfscrub, dwarfscrub_df$Elevation, method = "REML", add = TRUE, col = "blue")
    legend("topright", legend = "Elevation (Meters)", col = "blue", lty = 1, bty = "n", cex = 1.5)

#coloring by gradient 
    nmds_scores <- scores(scores(mds_dwarfscrub, display = "sites"))
    nmds_scores <- as.data.frame(nmds_scores)
    nmds_scores$Plot_Year <- dwarfscrub_df$Plot_Year
    nmds_scores$Elevation <- dwarfscrub_df$Elevation
    color_gradient <- colorRampPalette(c("blue", "red"))(100)
    point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
    ordiplot(mds_dwarfscrub, type = "n", xlim = xlim, ylim = ylim, cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Vascular Species)", cex.main = 2,
             xlab = "NMDS1", ylab = "NMDS2")
    text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.08",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
        text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "2",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
           fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
    points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Species Loading Values 
    
  #axis1 scores 
      axis1_scores <- scores(mds_dwarfscrub, display = "sites")[, 1]
      species_cor <- apply(dwarfscrub_composition, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_dwarfscrub, display = "sites")[, 2]
      species_cor <- apply(dwarfscrub_composition, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Lichen 
```{r}
#Run NMDS 
    mds_dwarfscrub_lichen <- metaMDS(dwarfscrub_composition_lichen, distance = "bray", k = 3, autotransform = TRUE, trymax = 200) 

#Get descriptive info 
    length(unique(dwarfscrub_df_lichen[["Plot"]])) #number of plots 
    mds_dwarfscrub_lichen$stress #stress value 
    mds_dwarfscrub_lichen$iters #number of iterations 

#define colors 
    veg_colors <- c("orange", "blue3", "firebrick1")
    names(veg_colors) <- unique(dwarfscrub_df_lichen$Viereck.3)
    dev.off()
#define axis
    xlim <- c(-1.5, 1)
    ylim <- c(-1.5, 1)

#plot with base overlay 
    ordiplot(mds_dwarfscrub_lichen, type = "n", xlim = xlim, ylim = ylim, 
             cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Lichen Species)", cex.main = 2,
             xlab = "NMDS1", ylab = "NMDS2")
    text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.08",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "5",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    points(scores(mds_dwarfscrub_lichen, display = "sites"),
           col = veg_colors[dwarfscrub_df_lichen$Viereck.3],
           pch = 19, cex = 1.6)
    legend("bottomleft", title = "Site Classification",
           legend=names(veg_colors),
           ncol=1,
           col = veg_colors, pch = 19, cex = 1.4)
    ordiarrows(mds_dwarfscrub_lichen, 
               groups = dwarfscrub_df_lichen$Plot, 
               levels = dwarfscrub_df_lichen$Sample_Year, col = 'blue')
    ordihull(mds_dwarfscrub_lichen, groups = dwarfscrub_df_lichen$Park, draw ="polygon", label = TRUE, cex = 1.8)
    ordihull(mds_dwarfscrub_lichen, groups = dwarfscrub_df_lichen$Elevation_Band, draw ="polygon", label = TRUE)

#ordisurf elevation contours     
    ordisurf(mds_dwarfscrub_lichen, dwarfscrub_df_lichen$Elevation, method = "REML", add = TRUE, col = "blue")
    legend("topright", legend = "Elevation (Meters)", col = "blue", lty = 1, bty = "n", cex = 1.5)

#plot labels if desired 
      text(mds_dwarfscrub_lichen, display = "sites", labels = dwarfscrub_df_lichen$Plot, col = "black", cex = 0.7, pos = 4)
      selected_plots <- c("KATM_2010_03_006", "KATM_2010_03_049", "LACL_2010_03_998", "LACL_2011_03_027", "KATM_2010_03_049")
      nmds_scores <- as.data.frame(scores(mds_dwarfscrub_lichen, display = "sites"))
      nmds_scores$Plot <- mds_dwarfscrub_lichen$Plot
      selected_scores <- nmds_scores[nmds_scores$Plot %in% selected_plots, ]
      text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$Plot,
           col = "black", cex = 0.7, pos = 4)

#coloring by elevation gradient 
      nmds_scores <- scores(scores(mds_dwarfscrub_lichen, display = "sites"))
      nmds_scores <- as.data.frame(nmds_scores)
      nmds_scores$Plot_Year <- dwarfscrub_df_lichen$Plot_Year
      nmds_scores$Elevation <- dwarfscrub_df_lichen$Elevation
      color_gradient <- colorRampPalette(c("blue", "red"))(100)
      point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
      ordiplot(mds_dwarfscrub_lichen, type = "n", xlim = xlim, ylim = ylim, 
                   cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Lichen Species)", cex.main = 2,
                   xlab = "NMDS1", ylab = "NMDS2")
      text(x = par("usr")[1],
               y = par("usr")[4] - 0.1,
               labels = "Stress = 0.08",
               pos = 4.1, #1: below, 2 left, 3 above, 4 right 
               cex = 2, #size 
               col = "black")
      text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "5",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
      legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
             fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
      points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Species Loading Values 
      
  #axis1 scores 
      axis1_scores <- scores(mds_dwarfscrub_lichen, display = "sites")[, 1]
      species_cor <- apply(dwarfscrub_composition_lichen, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_dwarfscrub_lichen, display = "sites")[, 2]
      species_cor <- apply(dwarfscrub_composition_lichen, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))
```


## Nonvascular 
```{r}
#Run NMDS 
    mds_dwarfscrub_nonvasc <- metaMDS(dwarfscrub_composition_nonvasc, distance = "bray", k = 3, autotransform = TRUE, trymax = 200) 

#Descriptive info for caption 
    length(unique(dwarfscrub_df_nonvasc[["Plot"]])) #16 plots 
    mds_dwarfscrub_nonvasc$stress #0.14
    mds_dwarfscrub_nonvasc$iters #200

#Define colors 
    veg_colors <- c("orange", "blue3", "firebrick1")
    names(veg_colors) <- unique(dwarfscrub_df_nonvasc$Viereck.3)
    dev.off()
#define axis 
    xlim <- c(-1.5, 1)
    ylim <- c(-1.5, 1)

#plot with base overlay 
    ordiplot(mds_dwarfscrub_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
             cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Nonvascular Species)", cex.main = 2,
             xlab = "NMDS1", ylab = "NMDS2")
    text(x = par("usr")[1],
         y = par("usr")[4] - 0.1,
         labels = "Stress = 0.13",
         pos = 4.1, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "2",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    points(scores(mds_dwarfscrub_nonvasc, display = "sites"),
           col = veg_colors[dwarfscrub_df_nonvasc$Viereck.3],
           pch = 19, cex = 1.5)
    legend("bottomleft", title = "Site Classification",
           legend=names(veg_colors),
           ncol=1,
           col = veg_colors, pch = 19, cex = 1.4)
    ordiarrows(mds_dwarfscrub_nonvasc, 
               groups = dwarfscrub_df_nonvasc$Plot, 
               levels = dwarfscrub_df_nonvasc$Sample_Year, col = 'blue')
    ordihull(mds_dwarfscrub_nonvasc, groups = dwarfscrub_df_nonvasc$Park, draw ="polygon", label = TRUE, cex = 1.8)
    ordihull(mds_dwarfscrub_nonvasc, groups = dwarfscrub_df_nonvasc$Viereck.3, draw ="polygon", label = TRUE)

#ordisurf elevation overlay 
    ordisurf(mds_dwarfscrub_nonvasc, dwarfscrub_df_nonvasc$Elevation, method = "REML", add = TRUE, col = "blue")
    legend("topright", legend = "Elevation (Meters)", col = "blue", lty = 1, bty = "n", cex = 1.5)

#plot labels if desired 
    text(mds_dwarfscrub_nonvasc, display = "sites", labels = dwarfscrub_df_nonvasc$Plot, col = "black", cex = 0.7, pos = 4)
    #adding only select labels 
    selected_plots <- c("001", "002", "003", "006")
    nmds_scores <- as.data.frame(scores(mds_dwarfscrub_nonvasc, display = "sites"))
    nmds_scores$Plot <- dwarfscrub_df_nonvasc$Plot
    selected_scores <- nmds_scores[nmds_scores$Plot %in% selected_plots, ]
    text(selected_scores$NMDS1, selected_scores$NMDS2, labels = selected_scores$PlotID,
         col = "black", cex = 0.7, pos = 4)

#coloring by gradient 
    nmds_scores <- scores(scores(mds_dwarfscrub_nonvasc, display = "sites"))
    nmds_scores <- as.data.frame(nmds_scores)
    nmds_scores$Plot_Year <- dwarfscrub_df_nonvasc$Plot_Year
    nmds_scores$Elevation <- dwarfscrub_df_nonvasc$Elevation
    color_gradient <- colorRampPalette(c("blue", "red"))(100)
    point_colors <- color_gradient[cut(nmds_scores$Elevation, breaks = 100)]
    ordiplot(mds_dwarfscrub_nonvasc, type = "n", xlim = xlim, ylim = ylim, 
                 cex.axis = 1.5, cex.lab = 1.4, main = "Dwarf Shrub (Nonvascular Species)", cex.main = 2,
                 xlab = "NMDS1", ylab = "NMDS2")
    text(x = par("usr")[1],
             y = par("usr")[4] - 0.1,
             labels = "Stress = 0.13",
             pos = 4.1, #1: below, 2 left, 3 above, 4 right 
             cex = 2, #size 
             col = "black")
    text(x = par("usr")[2],
         y = par("usr")[4] - 0.1,
         labels = "5",
         pos = 2, #1: below, 2 left, 3 above, 4 right 
         cex = 2, #size 
         col = "black")
    legend("bottomleft", legend = round(range(nmds_scores$Elevation), 2),
           fill = color_gradient[c(1, 100)], title = "Elevation (meters)", bty = "n", cex = 1.5)
    points(nmds_scores$NMDS1, nmds_scores$NMDS2, col = point_colors, pch = 19, cex = 1.7)

#Species loading values 
  #axis1 scores 
      axis1_scores <- scores(mds_dwarfscrub_nonvasc, display = "sites")[, 1]
      species_cor <- apply(dwarfscrub_composition_nonvasc, 2, function(species) cor (species, axis1_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

  #axis2 scores
      axis2_scores <- scores(mds_dwarfscrub_nonvasc, display = "sites")[, 2]
      species_cor <- apply(dwarfscrub_composition_nonvasc, 2, function(species) cor (species, axis2_scores, method = "spearman"))
      species_cor_sorted <- sort(species_cor, decreasing = TRUE)
      head(species_cor_sorted, 10)
      tail(species_cor_sorted, 10)
      
      species_cor_sorted <- as.data.frame(species_cor_sorted)
      species_cor_sorted <- species_cor_sorted %>%
        rownames_to_column(var = "Code1")
      species_cor_sorted <- species_cor_sorted %>%
        rename(Loadings = species_cor_sorted)
      str(species_cor_sorted)
      species_cor_sorted$Code1 <- factor(species_cor_sorted$Code1)
      taxa_filtered$Code1 <- factor(taxa_filtered$Code1)
      species_cor_sorted <- species_cor_sorted %>%
        left_join(taxa_filtered %>% select(Genus_Species, Code1), by = "Code1")
      species_cor_sorted <-species_cor_sorted %>% distinct()
      
      summary_df <- species_cor_sorted %>%
        arrange(Loadings) %>%
        slice(c(1:10, (n()-9):n()))

```



# Stepdown Analysis 

## Original, No species removed 
```{r}
presence_absence_df <- read_xlsx("T:/Users/KPace/SWAN-Internship/presence_absence_df.xlsx")
presence_absence_matrix <- presence_absence_df[, c(7:280)]  
presence_absence_matrix <- as.matrix(presence_absence_matrix)

mds_PA <- metaMDS(presence_absence_matrix, distance = "bray", k = 3, autotransform = TRUE, trymax = 100)
mds_PA$stress
mds_PA$iters
stressplot(mds_PA)
nmds_perm3 <- adonis2(presence_absence_matrix ~ mds_PA$points, permutations = 999, method = "bray")
nmds_perm3 
mds_PA$converged

#run numbers and stress values plots 
console_output <- "
Run 0 stress 0.105822 
Run 1 stress 0.1098654 
Run 2 stress 0.1086194 
Run 3 stress 0.1075743 
Run 4 stress 0.1082861 
Run 5 stress 0.1100464 
Run 6 stress 0.1069967 
Run 7 stress 0.110244 
Run 8 stress 0.1110138 
Run 9 stress 0.1062369 
Run 10 stress 0.1071309 
Run 11 stress 0.107434 
Run 12 stress 0.1083732 
Run 13 stress 0.1092917 
Run 14 stress 0.1112821 
Run 15 stress 0.1082839 
Run 16 stress 0.1104927 
Run 17 stress 0.1071206 
Run 18 stress 0.1079104 
Run 19 stress 0.1092736 
Run 20 stress 0.1073098 
Run 21 stress 0.1089363 
Run 22 stress 0.1074542 
Run 23 stress 0.1071377 
Run 24 stress 0.1071448 
Run 25 stress 0.108753 
Run 26 stress 0.1084697 
Run 27 stress 0.1095098 
Run 28 stress 0.1086396 
Run 29 stress 0.1076824 
Run 30 stress 0.1073184 
Run 31 stress 0.1082657 
Run 32 stress 0.1066196 
Run 33 stress 0.1070638 
Run 34 stress 0.1079281 
Run 35 stress 0.1091279 
Run 36 stress 0.110112 
Run 37 stress 0.1071212 
Run 38 stress 0.1081177 
Run 39 stress 0.1076833 
Run 40 stress 0.1062367 
Run 41 stress 0.1068637 
Run 42 stress 0.1087811 
Run 43 stress 0.108177 
Run 44 stress 0.1093357 
Run 45 stress 0.108714 
Run 46 stress 0.1072285 
Run 47 stress 0.1082103 
Run 48 stress 0.1103252 
Run 49 stress 0.1083443 
Run 50 stress 0.107299 
Run 51 stress 0.1081296 
Run 52 stress 0.1093474 
Run 53 stress 0.1079456 
Run 54 stress 0.1072762 
Run 55 stress 0.1082546 
Run 56 stress 0.1080521 
Run 57 stress 0.1079861 
Run 58 stress 0.1069541 
Run 59 stress 0.1071679 
Run 60 stress 0.1094484 
Run 61 stress 0.1074275 
Run 62 stress 0.1090347 
Run 63 stress 0.1075072 
Run 64 stress 0.1096317 
Run 65 stress 0.1091171 
Run 66 stress 0.1088092 
Run 67 stress 0.1093627 
Run 68 stress 0.1102438 
Run 69 stress 0.1086704 
Run 70 stress 0.1075101 
Run 71 stress 0.1078859 
Run 72 stress 0.108983 
Run 73 stress 0.1096279 
Run 74 stress 0.109392 
Run 75 stress 0.1094702 
Run 76 stress 0.1061103 
Run 77 stress 0.1094569 
Run 78 stress 0.1081975 
Run 79 stress 0.1089078 
Run 80 stress 0.1084812 
Run 81 stress 0.1085828 
Run 82 stress 0.1099863 
Run 83 stress 0.1087134 
Run 84 stress 0.1080331 
Run 85 stress 0.1067763 
Run 86 stress 0.1092575 
Run 87 stress 0.1097345 
Run 88 stress 0.1104582 
Run 89 stress 0.1081143 
Run 90 stress 0.1068049 
Run 91 stress 0.1071286 
Run 92 stress 0.1063498 
Run 93 stress 0.1073121 
Run 94 stress 0.1105416 
Run 95 stress 0.1088914 
Run 96 stress 0.1103212 
Run 97 stress 0.1110593 
Run 98 stress 0.1097989 
Run 99 stress 0.10903 
Run 100 stress 0.1093084 
"

#create dataframe
lines <- unlist(strsplit(console_output, "\n")) 
run_stress_lines <- grep("^Run \\d+ stress", lines, value = TRUE)  
run_numbers <- as.numeric(sub("Run (\\d+) stress.*", "\\1", run_stress_lines))  
stress_values <- as.numeric(sub("Run \\d+ stress ([0-9.]+)", "\\1", run_stress_lines))  

nmds_data <- data.frame(
  Run = run_numbers,
  Stress = stress_values)

ggplot(nmds_data, aes(x = Run, y = Stress)) +
  geom_point(color = "blue", size = 3) +
  geom_line(color = "darkgray", linetype = "dashed") +
  labs(title = "NMDS Stress Values Across Runs",
       x = "Run Number",
       y = "Stress Value") +
  theme_minimal()
```


## Removing species that only occur on one plot 
```{r}
#filter to remove species that occur at only one plot 
species_counts <- presence_absence_df %>%
  select(-Plot, -Plot_Year, -Park, -Elevation_Band, -EstYear, -Vegetation_Class, -PlotID, -Sample_Year) %>%
  colSums()
filtered_species <- names(species_counts[species_counts > 1])
filtered_presence_absence <- presence_absence_df %>%
  select(Plot, Plot_Year, all_of(filtered_species))

presence_absence_matrix1 <- filtered_presence_absence[, c(3:230)]  
presence_absence_matrix1 <- as.matrix(presence_absence_matrix1)


mds_PA1 <- metaMDS(presence_absence_matrix1, distance = "bray", k = 3, autotransform = TRUE, trymax = 100)
mds_PA1$stress
mds_PA1$iters
stressplot(mds_PA1)
nmds_perm3 <- adonis2(presence_absence_matrix1 ~ mds_PA1$points, permutations = 999, method = "bray")
nmds_perm3 
mds_PA1$converged
plot(mds_PA1) 

#run numbers and stress values plots 
console_output <- "
Run 0 stress 0.1056743 
Run 1 stress 0.1086317 
Run 2 stress 0.107313 
Run 3 stress 0.1074919 
Run 4 stress 0.1068883 
Run 5 stress 0.1075018 
Run 6 stress 0.1083246 
Run 7 stress 0.1086751 
Run 8 stress 0.1064131 
Run 9 stress 0.1088395 
Run 10 stress 0.1106565 
Run 11 stress 0.1071166 
Run 12 stress 0.1078242 
Run 13 stress 0.1085676 
Run 14 stress 0.1082809 
Run 15 stress 0.1108192 
Run 16 stress 0.1084835 
Run 17 stress 0.1078389 
Run 18 stress 0.1074423 
Run 19 stress 0.1095502 
Run 20 stress 0.1067968 
Run 21 stress 0.1094819 
Run 22 stress 0.1097424 
Run 23 stress 0.1089144 
Run 24 stress 0.1065705 
Run 25 stress 0.1085109 
Run 26 stress 0.1094794 
Run 27 stress 0.1075363 
Run 28 stress 0.1074128 
Run 29 stress 0.1084231 
Run 30 stress 0.1086663 
Run 31 stress 0.1081313 
Run 32 stress 0.1092612 
Run 33 stress 0.1091584 
Run 34 stress 0.1083643 
Run 35 stress 0.1088673 
Run 36 stress 0.1059095 
Run 37 stress 0.1089609 
Run 38 stress 0.1075933 
Run 39 stress 0.1090149 
Run 40 stress 0.107044 
Run 41 stress 0.1089256 
Run 42 stress 0.1066206 
Run 43 stress 0.1094173 
Run 44 stress 0.1094409 
Run 45 stress 0.1078831 
Run 46 stress 0.1086394 
Run 47 stress 0.1083939 
Run 48 stress 0.1091201 
Run 49 stress 0.1079204 
Run 50 stress 0.1073241 
Run 51 stress 0.1077824 
Run 52 stress 0.1095822 
Run 53 stress 0.1077402 
Run 54 stress 0.108729 
Run 55 stress 0.1086861 
Run 56 stress 0.1076044 
Run 57 stress 0.1072668 
Run 58 stress 0.107926 
Run 59 stress 0.1067787 
Run 60 stress 0.1075848 
Run 61 stress 0.1090494 
Run 62 stress 0.1094765 
Run 63 stress 0.1081908 
Run 64 stress 0.1073365 
Run 65 stress 0.106352 
Run 66 stress 0.1089908 
Run 67 stress 0.108205 
Run 68 stress 0.1066217 
Run 69 stress 0.1076833 
Run 70 stress 0.1081656 
Run 71 stress 0.1083026 
Run 72 stress 0.1073145 
Run 73 stress 0.1092793 
Run 74 stress 0.1097262 
Run 75 stress 0.109121 
Run 76 stress 0.108034 
Run 77 stress 0.1082541 
Run 78 stress 0.1092219 
Run 79 stress 0.1081639 
Run 80 stress 0.107465 
Run 81 stress 0.1104242 
Run 82 stress 0.1073289 
Run 83 stress 0.1077555 
Run 84 stress 0.1083904 
Run 85 stress 0.1087404 
Run 86 stress 0.1065485 
Run 87 stress 0.1092638 
Run 88 stress 0.1082784 
Run 89 stress 0.1087179 
Run 90 stress 0.1082153 
Run 91 stress 0.1067765 
Run 92 stress 0.1067739 
Run 93 stress 0.1097979 
Run 94 stress 0.1082041 
Run 95 stress 0.1120428 
Run 96 stress 0.1077949 
Run 97 stress 0.1094099 
Run 98 stress 0.1081199 
Run 99 stress 0.1103314 
Run 100 stress 0.1064198 
"

lines <- unlist(strsplit(console_output, "\n"))  
run_stress_lines <- grep("^Run \\d+ stress", lines, value = TRUE) 
run_numbers <- as.numeric(sub("Run (\\d+) stress.*", "\\1", run_stress_lines)) 
stress_values <- as.numeric(sub("Run \\d+ stress ([0-9.]+)", "\\1", run_stress_lines)) 
nmds_data <- data.frame(
  Run = run_numbers,
  Stress = stress_values)

ggplot(nmds_data, aes(x = Run, y = Stress)) +
  geom_point(color = "blue", size = 3) +
  geom_line(color = "darkgray", linetype = "dashed") +
  labs(title = "NMDS Stress Values Across Runs",
       x = "Run Number",
       y = "Stress Value") +
  theme_minimal()
```




## Removing species that only occur on 5% or less plots 
```{r}

threshold_5_percent <- 0.05 * nrow(presence_absence_df)
filtered_species_5 <- names(species_counts[species_counts > threshold_5_percent])
filtered_presence_absence_5 <- presence_absence_df %>%
  select(Plot, Plot_Year, all_of(filtered_species_5))

presence_absence_matrix2 <- filtered_presence_absence_5[, c(3:88)]  
presence_absence_matrix2 <- as.matrix(presence_absence_matrix2)

mds_PA2 <- metaMDS(presence_absence_matrix2, distance = "bray", k = 3, autotransform = TRUE, trymax = 100)
mds_PA2$stress
mds_PA2$iters
stressplot(mds_PA2)
nmds_perm3 <- adonis2(presence_absence_matrix2 ~ mds_PA2$points, permutations = 999, method = "bray")
nmds_perm3 
mds_PA2$converged
plot(mds_PA2)

#run numbers and stress values plots 
console_output <- "
Run 0 stress 0.1060636 
Run 1 stress 0.1099747 
Run 2 stress 0.1081927 
Run 3 stress 0.1078287 
Run 4 stress 0.1077541 
Run 5 stress 0.1095672 
Run 6 stress 0.1075993 
Run 7 stress 0.1081528 
Run 8 stress 0.1093773 
Run 9 stress 0.1079207 
Run 10 stress 0.1060517 
Run 11 stress 0.1089094 
Run 12 stress 0.1080083 
Run 13 stress 0.1081631 
Run 14 stress 0.1066578 
Run 15 stress 0.1093969 
Run 16 stress 0.108503 
Run 17 stress 0.1082523 
Run 18 stress 0.1076378 
Run 19 stress 0.1071997 
Run 20 stress 0.1080965 
Run 21 stress 0.1067788 
Run 22 stress 0.1085568 
Run 23 stress 0.108212 
Run 24 stress 0.1089156 
Run 25 stress 0.1080278 
Run 26 stress 0.1072475 
Run 27 stress 0.1094835 
Run 28 stress 0.1096968 
Run 29 stress 0.1094309 
Run 30 stress 0.1087878 
Run 31 stress 0.1098875 
Run 32 stress 0.1089892 
Run 33 stress 0.1080592 
Run 34 stress 0.1082036 
Run 35 stress 0.1090317 
Run 36 stress 0.1089041 
Run 37 stress 0.1077366 
Run 38 stress 0.1072548 
Run 39 stress 0.1095864 
Run 40 stress 0.1099087 
Run 41 stress 0.1087804 
Run 42 stress 0.1075245 
Run 43 stress 0.1101888 
Run 44 stress 0.1099253 
Run 45 stress 0.1102108 
Run 46 stress 0.109725 
Run 47 stress 0.1096517 
Run 48 stress 0.1096868 
Run 49 stress 0.1099494 
Run 50 stress 0.1099419 
Run 51 stress 0.1069951 
Run 52 stress 0.1068704 
Run 53 stress 0.1074722 
Run 54 stress 0.1085754 
Run 55 stress 0.1082569 
Run 56 stress 0.1089363 
Run 57 stress 0.109836 
Run 58 stress 0.1083206 
Run 59 stress 0.110539 
Run 60 stress 0.108525 
Run 61 stress 0.1068721 
Run 62 stress 0.1093022 
Run 63 stress 0.1079479 
Run 64 stress 0.1076061 
Run 65 stress 0.109293 
Run 66 stress 0.1100718 
Run 67 stress 0.1096619 
Run 68 stress 0.1093131 
Run 69 stress 0.1095827 
Run 70 stress 0.1088496 
Run 71 stress 0.1089047 
Run 72 stress 0.1098266 
Run 73 stress 0.1107215 
Run 74 stress 0.1086392 
Run 75 stress 0.1079375 
Run 76 stress 0.1093176 
Run 77 stress 0.1085461 
Run 78 stress 0.1097336 
Run 79 stress 0.1092802 
Run 80 stress 0.1103726 
Run 81 stress 0.1080607 
Run 82 stress 0.1064928 
Run 83 stress 0.1090225 
Run 84 stress 0.1107669 
Run 85 stress 0.1072957 
Run 86 stress 0.1072445 
Run 87 stress 0.1081032 
Run 88 stress 0.1109995 
Run 89 stress 0.1072086 
Run 90 stress 0.1086324 
Run 91 stress 0.1072875 
Run 92 stress 0.1097378 
Run 93 stress 0.108906 
Run 94 stress 0.1094072 
Run 95 stress 0.1102132 
Run 96 stress 0.108819 
Run 97 stress 0.1085966 
Run 98 stress 0.1086148 
Run 99 stress 0.1076164 
Run 100 stress 0.106482  
"

lines <- unlist(strsplit(console_output, "\n")) 
run_stress_lines <- grep("^Run \\d+ stress", lines, value = TRUE) 
run_numbers <- as.numeric(sub("Run (\\d+) stress.*", "\\1", run_stress_lines)) 
stress_values <- as.numeric(sub("Run \\d+ stress ([0-9.]+)", "\\1", run_stress_lines)) 
nmds_data <- data.frame(
  Run = run_numbers,
  Stress = stress_values)

ggplot(nmds_data, aes(x = Run, y = Stress)) +
  geom_point(color = "blue", size = 3) +
  geom_line(color = "darkgray", linetype = "dashed") +
  labs(title = "NMDS Stress Values Across Runs",
       x = "Run Number",
       y = "Stress Value") +
  theme_minimal()
```



## Removing species that only occur on 10% or less plots 
```{r}

threshold_10_percent <- 0.10 * nrow(presence_absence_df)
filtered_species_10 <- names(species_counts[species_counts > threshold_10_percent])
filtered_presence_absence_10 <- presence_absence_df %>%
  select(Plot, Plot_Year, all_of(filtered_species_10))

presence_absence_matrix3 <- filtered_presence_absence_10[, c(3:64)]  
presence_absence_matrix3 <- as.matrix(presence_absence_matrix3)


mds_PA3 <- metaMDS(presence_absence_matrix3, distance = "bray", k = 3, autotransform = TRUE, trymax = 100)
mds_PA3$stress
mds_PA3$iters
stressplot(mds_PA3)
nmds_perm3 <- adonis2(presence_absence_matrix3 ~ mds_PA3$points, permutations = 999, method = "bray")
nmds_perm3 
mds_PA3$converged
plot(mds_PA3)

#run numbers and stress values plots 
console_output <- "
Run 0 stress 0.1057704 
Run 1 stress 0.109045 
Run 2 stress 0.1105241 
Run 3 stress 0.1078137 
Run 4 stress 0.1105936 
Run 5 stress 0.1076395 
Run 6 stress 0.1078795 
Run 7 stress 0.1095057 
Run 8 stress 0.1070144 
Run 9 stress 0.106963 
Run 10 stress 0.1072511 
Run 11 stress 0.1070813 
Run 12 stress 0.1067263 
Run 13 stress 0.1070273 
Run 14 stress 0.1072665 
Run 15 stress 0.1089514 
Run 16 stress 0.1067059 
Run 17 stress 0.1092687 
Run 18 stress 0.1071931 
Run 19 stress 0.1094967 
Run 20 stress 0.1098972 
Run 21 stress 0.1061022 
Run 22 stress 0.1093268 
Run 23 stress 0.1103527 
Run 24 stress 0.1083207 
Run 25 stress 0.1079743 
Run 26 stress 0.1102208 
Run 27 stress 0.1085788 
Run 28 stress 0.1065249 
Run 29 stress 0.1122615 
Run 30 stress 0.1075237 
Run 31 stress 0.1084255 
Run 32 stress 0.1099926 
Run 33 stress 0.1074503 
Run 34 stress 0.1096085 
Run 35 stress 0.107081 
Run 36 stress 0.1089466 
Run 37 stress 0.109875 
Run 38 stress 0.1103504 
Run 39 stress 0.1099864 
Run 40 stress 0.1097388 
Run 41 stress 0.1076683 
Run 42 stress 0.1096345 
Run 43 stress 0.1099383 
Run 44 stress 0.1074376 
Run 45 stress 0.106331 
Run 46 stress 0.1086951 
Run 47 stress 0.1076308 
Run 48 stress 0.1100668 
Run 49 stress 0.1104589 
Run 50 stress 0.1073469 
Run 51 stress 0.1099133 
Run 52 stress 0.1089162 
Run 53 stress 0.1070278 
Run 54 stress 0.1083828 
Run 55 stress 0.1097071 
Run 56 stress 0.1076184 
Run 57 stress 0.1074999 
Run 58 stress 0.1108102 
Run 59 stress 0.1094232 
Run 60 stress 0.1113617 
Run 61 stress 0.110614 
Run 62 stress 0.107902 
Run 63 stress 0.1084476 
Run 64 stress 0.1060635 
Run 65 stress 0.1094094 
Run 66 stress 0.1088022 
Run 67 stress 0.1081681 
Run 68 stress 0.1075817 
Run 69 stress 0.1065038 
Run 70 stress 0.1087343 
Run 71 stress 0.1090846 
Run 72 stress 0.1075126 
Run 73 stress 0.1103302 
Run 74 stress 0.110623 
Run 75 stress 0.1078202 
Run 76 stress 0.1094802 
Run 77 stress 0.1078423 
Run 78 stress 0.1081968 
Run 79 stress 0.1077591 
Run 80 stress 0.1087888 
Run 81 stress 0.1111379 
Run 82 stress 0.1070544 
Run 83 stress 0.1081057 
Run 84 stress 0.106333 
Run 85 stress 0.1079622 
Run 86 stress 0.1091133 
Run 87 stress 0.1095968 
Run 88 stress 0.1091287 
Run 89 stress 0.1093696 
Run 90 stress 0.1071877 
Run 91 stress 0.1111122 
Run 92 stress 0.1070506 
Run 93 stress 0.1089585 
Run 94 stress 0.1075566 
Run 95 stress 0.1083439 
Run 96 stress 0.1127208 
Run 97 stress 0.1072553 
Run 98 stress 0.1088709 
Run 99 stress 0.1066136 
Run 100 stress 0.1086844   
"

lines <- unlist(strsplit(console_output, "\n"))  
run_stress_lines <- grep("^Run \\d+ stress", lines, value = TRUE) 
run_numbers <- as.numeric(sub("Run (\\d+) stress.*", "\\1", run_stress_lines)) 
stress_values <- as.numeric(sub("Run \\d+ stress ([0-9.]+)", "\\1", run_stress_lines))  
nmds_data <- data.frame(
  Run = run_numbers,
  Stress = stress_values)

ggplot(nmds_data, aes(x = Run, y = Stress)) +
  geom_point(color = "blue", size = 3) +
  geom_line(color = "darkgray", linetype = "dashed") +
  labs(title = "NMDS Stress Values Across Runs",
       x = "Run Number",
       y = "Stress Value") +
  theme_minimal()
```












